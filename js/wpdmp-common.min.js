function toggleProgressBar(){"none"==$jq("#progressbar").css("display")?$jq("#progressbar").css("display","block"):$jq("#progressbar").css("display","none")}function remove_marker(a){var e={action:"remove_marker",id:a,nt:(new Date).getTime()};toggleProgressBar(),$jq.post(ajaxurl,e,function(e){-1!=e.indexOf("removed-"+a)&&($jq("#markerprint"+a).fadeOut(600,function(){$jq("#markerprint"+a).detach()}),$jq("#m_"+a).remove(),$jq(".m_"+a+"_mo").remove()),toggleProgressBar()})}function save_marker(a){var e="";$jq(".descr_langs-"+a).each(function(){e=e+$jq(this).attr("lang")+"$%$"+$jq(this).val()+"#%#"});var t={action:"save_marker",id:a,desc:e,marker:$jq("input[name=marker-"+a+"]:checked").val(),nt:(new Date).getTime()};toggleProgressBar(),$jq.post(ajaxurl,t,function(e){var t=JSON.parse(e);"ERROR"==t.code?displayPopupMsg(t.msg,t.code):($jq(".m_"+a+"_mo").remove(),$jq("#m_"+a).remove(),set_marker(t.id,t.lat,t.lng,t.descr,t.marker,t.markerimg),$jq("#markerprint"+a).replaceWith(t.html),$jq("#tabs-"+a).tabs(),$jq("#savemarker-"+a).css("display","none"),add_onchange_handler(a),mapid=$jq("#mapimage").attr("mapid"),reload_map(mapid,"map",!0,"backend_marker_manager"),displayPopupMsg(wpdmp_popup.marker_success.msg,wpdmp_popup.marker_success.title)),toggleProgressBar()})}function add_marker(){$jq("#m_new_temp").remove(),$jq(".m_new_temp_mo").remove();var a="";$jq(".descr_langs-new").each(function(){a=a+$jq(this).attr("lang")+"$%$"+$jq(this).val()+"#%#"});var e;e="freehand"==get_maptype_from_map()?{action:"add_marker",mapid:$jq("#mapimage").attr("mapid"),address:$jq("#f_address").val(),lat:$jq("#freeX").val(),lng:$jq("#freeY").val(),desc:a,marker:$jq("input[name=marker-new]:checked").val(),nt:(new Date).getTime()}:{action:"add_marker",mapid:$jq("#mapimage").attr("mapid"),address:$jq("#f_address").val(),lat:$jq("#f_latitude").val(),lng:$jq("#f_longitude").val(),desc:a,marker:$jq("input[name=marker-new]:checked").val(),nt:(new Date).getTime()},toggleProgressBar(),$jq.post(ajaxurl,e,function(a){var e=JSON.parse(a);"ERROR"==e.code?displayPopupMsg(e.msg,e.code):(set_marker(e.id,e.lat,e.lng,e.descr,e.marker,e.markerimg),$jq("#newmarkerform")[0].reset(),$jq("#markerdesc").css("display","none"),$jq("#addmarker").css("display","none"),$jq("#markerslist").append(e.html),$jq("#tabs-"+e.id).tabs(),add_onchange_handler(e.id),mapid=$jq("#mapimage").attr("mapid"),reload_map(mapid,"map",!0,"backend_marker_manager"),displayPopupMsg(wpdmp_popup.marker_success.msg,wpdmp_popup.marker_success.title)),toggleProgressBar()})}function reload_site_list(a){var e={action:"reload_site_list",mapid:a,nt:(new Date).getTime()};$jq("#progressbar").css("display","block"),$jq.post(ajaxurl,e,function(a){$jq("#col-left").empty(),$jq("#col-left").append(a),setTimeout(function(){$jq(".markertabcontainer").tabs()},1e3),add_onchange_handler(-1),$jq("#progressbar").css("display","none")})}function reload_map(a,e,t,p){var r={action:"reload_map",mapid:a,mode:p,nt:(new Date).getTime()};"map-front"==e?"front_end_reload"==p?$jq.post(ajaxurl,r,function(a){$jq("#mapcontainer").empty(),$jq("#mapcontainer").append(a),$jq("#mapcontainer").imagesLoaded(function(a,t,p){$jq("#mapprogressbar").css("display","block");var r=getImageWidth("mapimage"),i=getImageHeight("mapimage");$jq("#mapprogressbar").css("top","-"+$jq("#mapimage").height()+"px").width(r).height(i);$jq("#mapimage").offset(),$jq("#mapoverlay").offset();$jq("#mapoverlay").css("top","0px").width("100%").height("100%"),$jq("#"+e).height($jq("#"+e).height()-i-$jq("#mapprogressbar").height()),align_markers(),"freehand"==get_maptype_from_map()&&setCoords_freehand(),$jq("#mapprogressbar").css("display","none")})}):$jq("#mapcontainer").imagesLoaded(function(a,t,p){$jq("#mapprogressbar").css("display","block");var r=getImageWidth("mapimage"),i=getImageHeight("mapimage");$jq("#mapprogressbar").css("top","-"+$jq("#mapimage").height()+"px").width(r).height(i);$jq("#mapimage").offset(),$jq("#mapoverlay").offset();$jq("#mapoverlay").css("top","0px").width("100%").height("100%"),$jq("#"+e).height($jq("#"+e).height()-i-$jq("#mapprogressbar").height()),align_markers(),$jq("#mapprogressbar").css("display","none")}):($jq("#progressbar").css("display","block"),$jq.post(ajaxurl,r,function(r){$jq("#map").empty(),$jq("#map").append(r),("backend_map_manager"==p||"backend_marker_manager"==p)&&($jq("#mapcontainer").imagesLoaded(function(a,t,p){$jq("#mapoverlay").css("top","0px").width($jq("#mapimage").width()).height($jq("#mapimage").height()),$jq("#"+e).height($jq("#mapimage").height()+$jq("#mapimage").offset().top),align_markers(),align_refpoints()}),"backend_marker_manager"==p&&(reload_site_list(a),attach_click_mapoverlay())),"backend_map_manager_google"==p&&(wpdmp_calibration_init(),init_goolge_calibrator()),"backend_map_manager"==p&&(t&&learn_map(),add_map_onchange_handler()),$jq("#progressbar").css("display","none")}))}function wpdmp_calibration_init(){var a={center:new google.maps.LatLng(20,-7),zoom:2};map=new google.maps.Map(document.getElementById("google-map-canvas"),a),overlay=new google.maps.OverlayView,overlay.draw=function(){},overlay.setMap(map),$jq("#map_draggable_container").draggable()}function getImageWidth(a){return document.getElementById(a).clientWidth}function getImageHeight(a){return document.getElementById(a).clientHeight}function set_markers(a,e){for(var t=JSON.parse(a),p=0;"undefined"!=typeof t[p];)set_marker(t[p].id,t[p].lat,t[p].lng,t[p].desc,t[p].marker,t[p].markerimg),p++}function get_refpoints_from_map(){var a=$jq("#mapimage").attr("refpoints"),e=null;return null!=a&&""!=a&&(e=JSON.parse("["+a+"]")),e}function get_maptype_from_map(){return $jq("#mapimage").attr("maptype")}function align_markers(){if("freehand"!=get_maptype_from_map()){var a=get_refpoints_from_map();if(null==a)return void displayPopupMsg(wpdmp_popup.add_two_ref.msg,wpdmp_popup.add_two_ref.title);if(refpoint1=a[0],refpoint2=a[1],"undefined"==typeof refpoint1||"undefined"==typeof refpoint2)return void displayPopupMsg(wpdmp_popup.add_one_ref.msg,wpdmp_popup.add_one_ref.title);dw1=getImageWidth("mapimage")/refpoint1.mapwidth,dw2=getImageWidth("mapimage")/refpoint2.mapwidth,dh1=getImageHeight("mapimage")/refpoint1.mapheight,dh2=getImageHeight("mapimage")/refpoint2.mapheight;var e=Math.abs(refpoint1.x-refpoint2.x)/Math.abs(refpoint1.lng-refpoint2.lng);$jq(".ctrl").each(function(){var a=$jq(this).attr("lat"),t=$jq(this).attr("lng"),p=getMarkerYForLatMerkator(a,refpoint1,refpoint2,dh1,dh2),r=((refpoint1.x+(t-refpoint1.lng)*e)*dw1+(refpoint2.x+(t-refpoint2.lng)*e)*dw2)/2;imh=$jq(this).height()/2,imw=$jq(this).width()/2;var i=getImageWidth("mapimage"),o=getImageHeight("mapimage"),n=pixelToPro(p-imh,o),s=pixelToPro(r-imw,i);$jq(this).css("top",n+"%").css("left",s+"%").css("display","block");var m=pixelToPro(parseInt($jq("#mapimage").attr("popupoffsetx"))+r,i),d=pixelToPro(parseInt($jq("#mapimage").attr("popupoffsety"))+p,o);$jq(".m_"+$jq(this).attr("mid")+"_mo").css("top",d+"%").css("left",m+"%")})}else"freehand"==get_maptype_from_map()&&$jq(".ctrl").each(function(){var a=100*$jq(this).attr("lat"),e=100*$jq(this).attr("lng");iw=getImageWidth("mapimage"),ih=getImageHeight("mapimage"),imh=$jq(this).height()/ih*100/2,imw=$jq(this).width()/iw*100/2,$jq(this).css("top",e-imh+"%").css("left",a-imw+"%").css("display","block");var t=pixelToPro(parseInt($jq("#mapimage").attr("popupoffsetx")),iw)+a,p=pixelToPro(parseInt($jq("#mapimage").attr("popupoffsety")),ih)+e;$jq(".m_"+$jq(this).attr("mid")+"_mo").css("top",p+"%").css("left",t+"%")})}function align_refpoints(){$jq(".ref").each(function(){var a=$jq(this).attr("x"),e=$jq(this).attr("y");$jq(this).css("top",e-8+"px").css("left",a-8+"px").css("display","block"),$jq("."+$jq(this).attr("id")+"_mo").css("top",e-5+"px").css("left",a+"px")})}function add_temp_place(a,e,t){var p="new_temp";$jq(".m_"+p+"_mo").remove(),$jq("#m_"+p).remove(),set_marker(p,a,e,t,0,$jq("#refpointimg").val())}function set_marker(id,lat,lng,desc,marker,markerimg){if("freehand"!=get_maptype_from_map()){var refs=get_refpoints_from_map();if(null==refs)return void displayPopupMsg(wpdmp_popup.add_two_ref.msg,wpdmp_popup.add_two_ref.title);if(refpoint1=refs[0],refpoint2=refs[1],"undefined"==typeof refpoint1||"undefined"==typeof refpoint2)return void displayPopupMsg(wpdmp_popup.add_one_ref.msg,wpdmp_popup.add_one_ref.title);var pxlng=Math.abs(refpoint1.x-refpoint2.x)/Math.abs(refpoint1.lng-refpoint2.lng);$jq("#mapoverlay").prepend('<img class="ctrl" id="m_'+id+'" src="'+markerimg+'"/>');var dy=getMarkerYForLatMerkator(lat,refpoint1,refpoint2,1,1),dx=(refpoint1.x+(lng-refpoint1.lng)*pxlng+(refpoint2.x+(lng-refpoint2.lng)*pxlng))/2,imh=$jq("#m_"+id).height()/2,imw=$jq("#m_"+id).width()/2;$jq("#m_"+id).css("top",dy-imh+"px").css("left",dx-imw+"px");var cur_desc="";try{cur_desc=eval("desc."+$jq("#mapimage").attr("cur_lang")+".descr")}catch(err){}var offsetx=parseInt($jq("#mapimage").attr("popupoffsetx"))+dx,offsety=parseInt($jq("#mapimage").attr("popupoffsety"))+dy;$jq("#mapoverlay").append('<div class="m_'+id+'_mo mappopupwrap" style="top:'+offsety+"px;left:"+offsetx+'px;"><div class="mappopup" id="#m_'+id+'_mo">'+cur_desc+"</div></div>")}else{$jq("#mapoverlay").prepend('<img class="ctrl" id="m_'+id+'" src="'+markerimg+'"/>');var mleft=100*lat,mtop=100*lng;iw=getImageWidth("mapimage"),ih=getImageHeight("mapimage"),imh=pixelToPro($jq("#m_"+id).height(),ih)/2,imw=pixelToPro($jq("#m_"+id).width(),iw)/2,$jq("#m_"+id).css("top",mtop-imh+"%").css("left",mleft-imw+"%");var cur_desc="";try{cur_desc=eval("desc."+$jq("#mapimage").attr("cur_lang")+".descr")}catch(err){}var offsetx=pixelToPro(parseInt($jq("#mapimage").attr("popupoffsetx")),iw)+mleft,offsety=pixelToPro(parseInt($jq("#mapimage").attr("popupoffsety")),ih)+mtop;$jq("#mapoverlay").append('<div class="m_'+id+'_mo mappopupwrap" style="top:'+offsety+"%;left:"+offsetx+'%;"><div class="mappopup" id="#m_'+id+'_mo">'+cur_desc+"</div></div>")}}function pixelToPro(a,e){return a/e*100}function put_popup_inside_the_map(){mapx=$jq("#mapimage").offset().left}function add_effects(){$jq(".ctrl").on("mouseenter",function(a){adjust_popup_position(a),$jq("."+a.target.id+"_mo").fadeIn("fast"),$jq(".mappopup").on("mouseleave",function(a){$jq(".mappopupwrap").fadeOut("slow")})}),$jq(".ref").on("mouseenter",function(a){$jq(".mappopupwrap").hide(),$jq("."+a.target.id+"_mo").fadeIn("fast")}),"function"==typeof add_custom_effects&&add_custom_effects()}function adjust_popup_position(a){docw=$jq(window).width(),mapx=$jq("#mapimage").offset().left,mapwidth=$jq("#mapimage").width();var e=$jq(window).height(),t=$jq("#mapimage").offset().top,p=$jq("#mapimage").height();if($jq(".mappopupwrap").hide(),!$jq("."+a.target.id+"_mo").attr("initleft")){left=$jq("."+a.target.id+"_mo").css("left");var r=$jq("."+a.target.id+"_mo").css("top");left.indexOf("%")>-1?units="%":units="px",$jq("."+a.target.id+"_mo").attr("initleft",parseFloat(left)),$jq("."+a.target.id+"_mo").attr("inittop",parseFloat(r)),$jq("."+a.target.id+"_mo").attr("units",units)}popupcssleft=parseFloat($jq("."+a.target.id+"_mo").attr("initleft"));var i=parseFloat($jq("."+a.target.id+"_mo").attr("inittop"));units=$jq("."+a.target.id+"_mo").attr("units"),"%"==units&&(popupcssleft=popupcssleft*mapwidth/100,i=i*p/100),popupright=mapx+popupcssleft+$jq("."+a.target.id+"_mo").width()-$jq(window).scrollLeft();var o=t+i+$jq("."+a.target.id+"_mo").height()-$jq(window).scrollTop();changedx=0,changedy=0,1==$jq("#mapimage").attr("popuplocation")&&(popupright>mapx+mapwidth-$jq(window).scrollLeft()&&(changedx=popupright-mapx-mapwidth+$jq(window).scrollLeft()),popupcssleft<0&&(changedx=popupcssleft),0>i&&(changedy=i),o>t+p-$jq(window).scrollTop()&&(changedy=o-t-p+$jq(window).scrollTop())),popupright-changedx>docw&&(changedx=popupright-docw),o-changedy>e&&(changedy=o-e),$jq("."+a.target.id+"_mo").css("left",popupcssleft-changedx+"px"),$jq("."+a.target.id+"_mo").css("top",i-changedy+"px")}function marker_zoom(a,e){"undefined"==typeof $jq(a).attr("inittop")&&($jq(a).attr("inittop",$jq(a).position().top),$jq(a).attr("initleft",$jq(a).position().left)),e?($jq(a).animate({width:"50px",height:"50px",top:$jq(a).attr("inittop")-12+"px",left:$jq(a).attr("initleft")-12+"px"}),$jq(".mappopupwrap").hide(),$jq("."+$jq(a).attr("id")+"_mo").fadeIn("fast")):($jq(".mappopupwrap").hide(),$jq(a).animate({width:"25px",height:"25px",top:$jq(a).attr("inittop")+"px",left:$jq(a).attr("initleft")+"px"}))}function add_onchange_handler(a){-1!=a?($jq("[id^=f_text-"+a+"]").change(function(){var a=$jq(this).attr("id").split("-");$jq("#savemarker-"+a[1]).css("display","block")}),$jq("[id^=f_text-"+a+"]").keyup(function(){var a=$jq(this).attr("id").split("-");$jq("#savemarker-"+a[1]).css("display","block")}),$jq("input[name='marker-"+a+"']").change(function(){$jq("#save"+$jq(this).attr("name")).css("display","block")})):($jq("[class^=descr_langs]").change(function(){var a=$jq(this).attr("id").split("-");$jq("#savemarker-"+a[1]).css("display","block")}),$jq("[class^=descr_langs]").keyup(function(){var a=$jq(this).attr("id").split("-");$jq("#savemarker-"+a[1]).css("display","block")}),$jq("input[type='radio']").change(function(){$jq("#save"+$jq(this).attr("name")).css("display","block")}))}function getPxForLatLng(){var a=$jq("#map_draggable_container").css("top");a=a.substring(0,a.indexOf("px"));var e=$jq("#map_draggable_container").css("left");e=parseInt(e.substring(0,e.indexOf("px")));var t=new google.maps.Point(parseInt(e),parseInt(a)),p=new google.maps.Point(parseInt(e)+$jq("#map_draggable_container").width(),parseInt(a)+$jq("#map_draggable_container").height()),r=overlay.getProjection().fromContainerPixelToLatLng(t),i=overlay.getProjection().fromContainerPixelToLatLng(p),o={mapid:$jq("#map_draggable").attr("mapid"),mapwidth:$jq("#map_draggable").attr("mapw"),mapheight:$jq("#map_draggable").attr("maph"),address:"",lat:r.lat(),lng:r.lng(),x:1,y:1},n={mapid:$jq("#map_draggable").attr("mapid"),mapwidth:$jq("#map_draggable").attr("mapw"),mapheight:$jq("#map_draggable").attr("maph"),address:"",lat:i.lat(),lng:i.lng(),x:$jq("#map_draggable").attr("mapw"),y:$jq("#map_draggable").attr("maph")};save_ref_points_google($jq("#map_draggable").attr("mapid"),{1:o,2:n})}function getMarkerYForLatMerkator(a,e,t,p,r){var i=e.mapheight*p-e.y*p,o=t.mapheight*r-t.y*r,n=MathLib.arsinh(Math.tan(a*Math.PI/180)),s=MathLib.arsinh(Math.tan(e.lat*Math.PI/180)),m=MathLib.arsinh(Math.tan(t.lat*Math.PI/180)),d=Math.abs((i-o)/(s-m)),g=s*d,l=n*d,c=g-i,f=l-c;return f=e.mapheight*r-f}function getMarkerYForLatLinear(a,e,t,p,r){var i=Math.abs(e.y-t.y)/Math.abs(e.lat-t.lat);return((e.y+(e.lat-a)*i)*p+(t.y+(t.lat-a)*i)*r)/2}function displayPopupMsg(a,e){$jq("#wpdmp_popup_dialog p").text(a),$jq("#wpdmp_popup_dialog").dialog({title:e,width:400,modal:!0,buttons:{OK:function(){$jq(this).dialog("close")}}})}function expandMarkerInfo(a){$jq("document").ready(function(){$jq("#markerprint_slider-"+a).slideToggle(function(){$jq("#slidericon-"+a).attr("class",function(e,t){return $jq("#markerprint_slider-"+a).is(":visible")?t.replace("-down","-up"):t.replace("-up","-down")})})})}var $jq=jQuery.noConflict();