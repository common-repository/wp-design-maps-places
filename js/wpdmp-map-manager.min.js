function learn_map(){clearCoords(".ui-dialog #f_address",".ui-dialog #f_latitude",".ui-dialog #f_longitude"),$jq("div.ui-dialog").remove();var a=$jq("#modalCoordDialog");a.dialog({dialogClass:"wpdmp-dialog",modal:!0,autoOpen:!1,closeOnEscape:!1,buttons:{Close:function(){$jq(this).dialog("close")},Save:function(){return"found"!=$jq("#coordsFound").val()?void displayPopupMsg(wpdmp_popup.alert_msg.msg,wpdmp_popup.alert_msg.title):(save_ref_point($jq("#mapimage").attr("mapid"),getImageWidth("mapimage"),getImageHeight("mapimage"),$jq(".ui-dialog #f_address").val(),$jq(".ui-dialog #f_latitude").val(),$jq(".ui-dialog #f_longitude").val(),$jq("#refX").val(),$jq("#refY").val()),void $jq(this).dialog("close"))}}}),attach_click_mapoverlay(a)}function attach_click_mapoverlay(a){$jq("#mapoverlay").click(function(e){var t=get_refpoints_from_map();if(null!=t&&t.length>1)displayPopupMsg(wpdmp_popup.remove_ref.msg,wpdmp_popup.remove_ref.title);else{e.preventDefault();var i=e.pageX-$jq("#mapimage").offset().left,o=e.pageY-$jq("#mapimage").offset().top;if($jq("#refX").val(i),$jq("#refY").val(o),"freehand"!=get_maptype_from_map())a.dialog("open");else{e.preventDefault(),$jq("#markerdesc").css("display","block"),$jq("#addmarker").css("display","block");var i=(e.pageX-$jq("#mapimage").offset().left)/$jq("#mapimage").width(),o=(e.pageY-$jq("#mapimage").offset().top)/$jq("#mapimage").height();$jq("#freeX").val(i),$jq("#freeY").val(o)}}}).children().click(function(a){return!1})}function save_ref_point(a,e,t,i,o,p,r,s){var l={action:"save_ref_point",mapid:a,mapwidth:e,mapheight:t,address:i,lat:o,lng:p,x:r,y:s,nt:(new Date).getTime()};toggleProgressBar(),$jq.post(ajaxurl,l,function(e){-1!=e.indexOf("created")?(get_map_status(a),reload_map(a,"map",!0,"backend_map_manager")):displayPopupMsg(wpdmp_popup.ref_fail.msg,wpdmp_popup.ref_fail.title),toggleProgressBar()})}function save_ref_points_google(a,e){var t={action:"save_ref_points",mapid:a,refpoints:JSON.stringify(e),nt:(new Date).getTime(),traditional:!1};toggleProgressBar(),$jq.post(ajaxurl,t,function(e){-1!=e.indexOf("created")?(get_map_status(a),reload_map(a,"map",!0,"backend_map_manager")):displayPopupMsg(wpdmp_popup.ref_fail.msg,wpdmp_popup.ref_fail.title),toggleProgressBar()})}function delete_ref_point(a){var e=$jq("#mapimage").attr("mapid"),t={action:"delete_ref_point",id:a,mapid:e,nt:(new Date).getTime()};toggleProgressBar(),$jq.post(ajaxurl,t,function(a){-1!=a.indexOf("removed")?(get_map_status(e),reload_map($jq("#mapimage").attr("mapid"),"map",!0,"backend_map_manager")):(displayPopupMsg(wpdmp_popup.ref_fail.msg,wpdmp_popup.ref_fail.title),toggleProgressBar())})}function get_map_status(a){var e={action:"get_map_status",mapid:a,nt:(new Date).getTime()};$jq.post(ajaxurl,e,function(e){$jq("#mapstatus-"+a).empty(),$jq("#mapstatus-"+a).append(e)})}function print_maps_available(){var a={action:"print_maps_available",nt:(new Date).getTime()};$jq.post(ajaxurl,a,function(a){$jq("#col-left").empty(),$jq("#col-left").append(a),add_map_onchange_handler()})}function add_map_onchange_handler(){$jq("[id^=xoffset_]").change(function(){$jq("#save_popup_offset_"+$jq(this).attr("mapid")).css("display","inline")}),$jq("[id^=yoffset_]").change(function(){$jq("#save_popup_offset_"+$jq(this).attr("mapid")).css("display","inline")}),$jq("[id^=xoffset_]").keyup(function(){$jq("#save_popup_offset_"+$jq(this).attr("mapid")).css("display","inline")}),$jq("[id^=yoffset_]").keyup(function(){$jq("#save_popup_offset_"+$jq(this).attr("mapid")).css("display","inline")}),$jq("[id^=popup_loc_]").on("change",function(){$jq("#save_popup_location_"+$jq(this).attr("mapid")).css("display","inline")})}function save_popup_offset(a,e,t){if(isNaN(e)||isNaN(t))return void displayPopupMsg(wpdmp_popup.popup_offset_validation_error.msg,wpdmp_popup.popup_offset_validation_error.title);var i={action:"save_popup_offset",mapid:a,offsetx:e,offsety:t,nt:(new Date).getTime()};toggleProgressBar(),$jq.post(ajaxurl,i,function(e){var t=$jq.parseJSON(e);"ERROR"!=t.code?reload_map(a,"map",!0,"backend_map_manager"):displayPopupMsg(t.msg),$jq("#save_popup_offset_"+a).css("display","none"),toggleProgressBar()})}function save_popup_location(a,e){var t={action:"save_popup_location",mapid:a,val:e,nt:(new Date).getTime()};toggleProgressBar(),$jq.post(ajaxurl,t,function(e){var t=$jq.parseJSON(e);"ERROR"!=t.code?reload_map(a,"map",!0,"backend_map_manager"):displayPopupMsg(t.msg),$jq("#save_popup_location_"+a).css("display","none"),toggleProgressBar()})}function delete_map_dialog(a){$jq(function(){$jq("#dialog-confirm").dialog({resizable:!1,height:200,width:450,draggable:!1,modal:!0,buttons:{"Delete the map":function(){$jq(this).dialog("close"),delete_map(a)},Cancel:function(){$jq(this).dialog("close")}}})})}function delete_map(a){var e={action:"delete_map",mapid:a,nt:(new Date).getTime()};toggleProgressBar(),$jq.post(ajaxurl,e,function(e){var t=$jq.parseJSON(e);if("ERROR"==t.code)displayPopupMsg(t.msg);else{$jq("#map_"+a).parent().remove();var i=t.mapid;null!=i?reload_map(i,"map",!0,"backend_map_manager"):$jq("#map").empty()}}),toggleProgressBar()}function add_map(a){var e={action:"add_map",attachmentid:a,nt:(new Date).getTime()};toggleProgressBar(),$jq.post(ajaxurl,e,function(a){var e=$jq.parseJSON(a);return"ERROR"==e.code?(displayPopupMsg(e.msg),void toggleProgressBar()):(reload_map(a,"map",!0,"backend_map_manager"),print_maps_available(),void toggleProgressBar())})}function selectMarkersFiles(a,e){return a.preventDefault(),$jq("#curmapid").val(e),file_frame_markers?void file_frame_markers.open():(file_frame_markers=wp.media.frames.file_frame=wp.media({title:$jq(this).data("uploader_title"),button:{text:$jq(this).data("uploader_button_text")},multiple:!0}),file_frame_markers.on("select",function(){var a=file_frame_markers.state().get("selection"),e=a.map(function(a){return a=a.toJSON(),a.id}).join();add_markers_to_map($jq("#curmapid").val(),e)}),file_frame_markers.on("open",function(){$jq("img[mapid='"+$jq("#curmapid").val()+"'].markers_list").each(function(){attachment=wp.media.attachment($jq(this).attr("attid")),attachment.fetch(),file_frame_markers.state().get("selection").add(attachment?[attachment]:[])})}),file_frame_markers.open(),void 0)}function add_markers_to_map(a,e){var t={action:"add_markers_to_map",mapid:a,attachmentids:e,nt:(new Date).getTime()};toggleProgressBar(),$jq.post(ajaxurl,t,function(a){var e=$jq.parseJSON(a);return"ERROR"==e.code?(displayPopupMsg(e.msg),void toggleProgressBar()):($jq("#col-left").empty(),$jq("#col-left").append(e),$jq(".ajaxmessage").length>0&&(displayPopupMsg($jq(".ajaxmessage").text()),$jq(".ajaxmessage").remove()),void toggleProgressBar())})}function selectMapFile(a){return a.preventDefault(),file_frame?void file_frame.open():(file_frame=wp.media.frames.file_frame=wp.media({title:$jq(this).data("uploader_title"),button:{text:$jq(this).data("uploader_button_text")},multiple:!1}),file_frame.on("select",function(){attachment=file_frame.state().get("selection").first().toJSON(),add_map(attachment.id)}),void file_frame.open())}function position_google_map(a){geocoder=new google.maps.Geocoder(a),geocoder.geocode({address:a},function(a,e){e==google.maps.GeocoderStatus.OK?(map.panTo(new google.maps.LatLng(a[0].geometry.location.lat(),a[0].geometry.location.lng())),map.fitBounds(a[0].geometry.bounds)):displayPopupMsg(wpdmp_popup.check_addr.msg,wpdmp_popup.check_addr.title)})}function init_goolge_calibrator(){$jq("#map_draggable_container").css("display","block");var a=$jq("#map_draggable").attr("maph")/$jq("#map_draggable").attr("mapw");$jq("#mapimage").imagesLoaded(function(e,t,i){a>.9?($jq("#map_draggable_container").css("height",$jq("#google-map-canvas").height()),$jq("#map_draggable").css("height",$jq("#google-map-canvas").height()),$jq("#map_draggable_container").css("width",$jq("#map_draggable").width()),$jq("#map_draggable_container").css("left",($jq("#google-map-canvas").width()-$jq("#google-map-canvas").height()/a)/2)):($jq("#map_draggable_container").css("width",$jq("#google-map-canvas").width()-200),$jq("#map_draggable").css("width",$jq("#google-map-canvas").width()-200),$jq("#map_draggable_container").css("left","100px"),$jq("#map_draggable_container").css("top",($jq("#google-map-canvas").height()-$jq("#map_draggable_container").height())/2)),init_sliders()})}function init_sliders(){var a=$jq("#map_draggable").height(),e=$jq("#map_draggable").width();$jq("#keepratio_check").css("outline-color","red"),$jq("#keepratio_check").css("outline-style","solid"),$jq("#keepratio_check").css("outline-width","thin"),$jq("#vslider").slider({value:a,range:"max",min:0,max:2*a-100,step:3,animate:"fast",orientation:"vertical",slide:function(t,i){parseInt($jq(this).data("value"));$jq("#map_draggable_container").css("height",2*a-i.value),$jq("#map_draggable").css("height",2*a-i.value),$jq("#keepratio_check").prop("checked")&&($jq("#hslider").slider("value",e*(2*a-i.value)/a),$jq("#map_draggable_container").css("width",$jq("#hslider").slider("value")),$jq("#map_draggable").css("width",$jq("#hslider").slider("value")))}}),$jq("#hslider").slider({value:e,range:"max",min:100,max:2*e,step:3,animate:"fast",slide:function(t,i){$jq("#map_draggable_container").css("width",i.value),$jq("#map_draggable").css("width",i.value),$jq("#keepratio_check").prop("checked")&&($jq("#vslider").slider("value",2*a-a*i.value/e),$jq("#map_draggable_container").css("height",2*a-$jq("#vslider").slider("value")),$jq("#map_draggable").css("height",2*a-$jq("#vslider").slider("value")))}})}function mark_free_hand_map(a){var e={action:"mark_free_hand_map",mapid:a,nt:(new Date).getTime()};toggleProgressBar(),$jq.post(ajaxurl,e,function(e){var t=$jq.parseJSON(e);return"ERROR"==t.code?(displayPopupMsg(t.msg),void toggleProgressBar()):(get_map_status(a),reload_map(a,"map",!0,"backend_map_manager"),void toggleProgressBar())})}var file_frame_markers,file_frame;